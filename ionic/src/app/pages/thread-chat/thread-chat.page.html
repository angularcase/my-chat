<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/spaces"></ion-back-button>
    </ion-buttons>
    <ion-title>Czat</ion-title>
    @if (thread?.status === 'closed') {
      <ion-badge color="medium" slot="end">Zamknięty</ion-badge>
    }
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @if (loading) {
    <ion-spinner name="crescent"></ion-spinner>
  } @else if (error) {
    <p color="danger">{{ error }}</p>
  } @else if (thread) {
    @if (thread.status === 'unassigned') {
      <ion-button expand="block" (click)="claim()" [disabled]="claiming">
        {{ claiming ? 'Przejmowanie…' : 'Przejmij wątek' }}
      </ion-button>
    }

    <ion-list>
      @for (msg of messages; track msg.id || msg.createdAt) {
        <ion-item [class.agent-msg]="msg.senderType === 'agent'">
          <ion-label>
            <p><strong>{{ msg.senderType === 'agent' ? 'Ty' : 'Visitor' }}</strong></p>
            <p>{{ msg.content }}</p>
            <p class="ion-text-end">{{ msg.createdAt | date:'shortTime' }}</p>
          </ion-label>
        </ion-item>
      }
    </ion-list>

    @if (thread.status !== 'closed') {
      <div class="input-row">
        <ion-input
          placeholder="Wiadomość…"
          [(ngModel)]="newMessage"
          (keyup.enter)="send()"
          [disabled]="sending"
        ></ion-input>
        <ion-button (click)="send()" [disabled]="sending || !newMessage.trim()">
          Wyślij
        </ion-button>
      </div>
    }

    @if (thread.status === 'active') {
      <ion-button expand="block" color="medium" fill="outline" class="ion-margin-top" (click)="closeThread()">
        Zamknij wątek
      </ion-button>
    }
  }
</ion-content>
